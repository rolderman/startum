import { KuzzleRequest } from "kuzzle"
import parseCollections from "./parseCollections"
import taskPipe from "./taskPipe"

// search request
const request: KuzzleRequest = JSON.parse('{\"internalId\":\"c0bf0bff-2206-43c1-bcab-44d83f0d495f\",\"status\":200,\"input\":{\"jwt\":\"kauth-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiJrdWlkLXJhcmUtcGhvdG9qb3VybmFsaXN0LTMzMzQxIiwiaWF0IjoxNjkzOTE3NDAwLCJleHAiOjE2OTQ1MjIyMDB9.gFj4ytT1Mz_TtZNhBAFoSDhYEvgEygpTdyQva7ayQoo\",\"volatile\":{\"sdkInstanceId\":\"db716669-ac82-4595-8d68-bbd34d9857f9\",\"sdkName\":\"js@7.11.0\"},\"body\":{\"query\":{\"multi_match\":{\"query\":\"123\",\"fuzziness\":1,\"fields\":[\"content.firstName.search\"]}}},\"controller​\":\"document\",\"action​\":\"search\",\"args\":{\"targets\":[{\"index\":\"startum_v1\",\"collections\":[\"manager_v1\"]}],\"requestId\":\"9bb9aea9-ff4d-454a-ad11-d619670cd1ab\"},\"resource\":{\"args\":{\"targets\":[{\"index\":\"startum_v1\",\"collections\":[\"manager_v1\"]}],\"requestId\":\"9bb9aea9-ff4d-454a-ad11-d619670cd1ab\"}},\"headers​\":{\"host\":\"startum.kuzzle.d2.rolder.app\",\"user-agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Noodl/2.9.1 Chrome/112.0.5615.50 Electron/24.1.1 Safari/537.36\",\"accept-encoding\":\"gzip, deflate, br\",\"accept-language\":\"en-GB\",\"cache-control\":\"no-cache\",\"connection\":\"Upgrade\",\"origin\":\"http://localhost:8574\",\"pragma\":\"no-cache\",\"sec-websocket-extensions\":\"permessage-deflate; client_max_window_bits\",\"sec-websocket-key\":\"MrI+kZJ1ChyddulVx4kOwQ==\",\"sec-websocket-protocol\":\"null\",\"sec-websocket-version\":\"13\",\"upgrade\":\"websocket\",\"x-forwarded-for\":\"10.42.0.0\",\"x-forwarded-host\":\"startum.kuzzle.d2.rolder.app\",\"x-forwarded-port\":\"443\",\"x-forwarded-proto\":\"wss\",\"x-forwarded-server\":\"traefik-56b8c5fb5c-7j2rl\",\"x-real-ip\":\"10.42.0.0\"}},\"context​\":{\"connection\":{\"id\":\"3d8a3b90-d3e6-428c-94a2-f179c66b69d7\",\"ips\":[\"0000:0000:0000:0000:0000:ffff:0a2a:0156\"],\"protocol\":\"websocket\",\"headers\":{\"host\":\"startum.kuzzle.d2.rolder.app\",\"user-agent\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Noodl/2.9.1 Chrome/112.0.5615.50 Electron/24.1.1 Safari/537.36\",\"accept-encoding\":\"gzip, deflate, br\",\"accept-language\":\"en-GB\",\"cache-control\":\"no-cache\",\"connection\":\"Upgrade\",\"origin\":\"http://localhost:8574\",\"pragma\":\"no-cache\",\"sec-websocket-extensions\":\"permessage-deflate; client_max_window_bits\",\"sec-websocket-key\":\"MrI+kZJ1ChyddulVx4kOwQ==\",\"sec-websocket-protocol\":\"null\",\"sec-websocket-version\":\"13\",\"upgrade\":\"websocket\",\"x-forwarded-for\":\"10.42.0.0\",\"x-forwarded-host\":\"startum.kuzzle.d2.rolder.app\",\"x-forwarded-port\":\"443\",\"x-forwarded-proto\":\"wss\",\"x-forwarded-server\":\"traefik-56b8c5fb5c-7j2rl\",\"x-real-ip\":\"10.42.0.0\"},\"internal\":{}},\"token\":{\"_id\":\"kuid-rare-photojournalist-33341#kauth-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiJrdWlkLXJhcmUtcGhvdG9qb3VybmFsaXN0LTMzMzQxIiwiaWF0IjoxNjkzOTE3NDAwLCJleHAiOjE2OTQ1MjIyMDB9.gFj4ytT1Mz_TtZNhBAFoSDhYEvgEygpTdyQva7ayQoo\",\"expiresAt\":1694522200029,\"ttl\":604800000,\"userId\":\"kuid-rare-photojournalist-33341\",\"jwt\":\"kauth-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiJrdWlkLXJhcmUtcGhvdG9qb3VybmFsaXN0LTMzMzQxIiwiaWF0IjoxNjkzOTE3NDAwLCJleHAiOjE2OTQ1MjIyMDB9.gFj4ytT1Mz_TtZNhBAFoSDhYEvgEygpTdyQva7ayQoo\",\"refreshed\":false,\"singleUse\":false},\"user\":{\"_id\":\"kuid-rare-photojournalist-33341\",\"profileIds\":[\"companyWriter\",\"companyReader\"],\"role\":{\"value\":\"admin\",\"title\":\"Администратор Startum\"},\"_kuzzle_info\":{\"author\":\"kuid-frustrating-archaeologist-85153\",\"createdAt\":1693368469861,\"updatedAt\":null,\"updater\":null}}},\"error\":null,\"result\":{\"hits\":[],\"total\":0},\"response\":null,\"id\":\"9bb9aea9-ff4d-454a-ad11-d619670cd1ab\",\"timestamp\":1693917401091}')
// this.pipe.register
const collections = parseCollections(request)
collections?.forEach(collection => {
    const dbClass = collection.split('_')[0]
    if (dbClass === 'task') return taskPipe(undefined, collection, request)
    return request
})